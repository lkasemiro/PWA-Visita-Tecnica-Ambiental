<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Formulário Técnico CEDAE (Offline)</title>
  <meta name="theme-color" content="#0C3C78">
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  
  <style>
    /* Estilos do código original */
    body { background-color: #f8f9fa; margin:0; padding:0; font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .logo { width:100%; max-width:180px; margin:10px auto; display:block }
    .btn { font-weight:600; border-radius:8px }
    .section-card{ background:white; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.08); margin-bottom:20px; padding:15px }
    .section-title{ color:#0C3C78; font-weight:700; margin-bottom:10px }
    .progress-bar{ background-color:#51C751 }
    #mapa_local{ height: 200px; border-radius: 8px; margin-top: 10px; }
    .hidden { display: none; }
    
    /* Estilos para a Câmera */
    .camera-container { position: relative; width: 100%; height: 300px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 8px; overflow: hidden;}
    video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
    .capture-btn-container { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 10;}
    .photo-preview { max-width: 100%; max-height: 280px; margin-top: 10px; border-radius: 8px; object-fit: contain; }
    
    /* Estilos para Notificação e Spinner */
    .notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 8px; color: white; z-index: 1000; transition: opacity 0.3s; opacity: 0; }
    .notification.success { background-color: #51C751; }
    .notification.error { background-color: #EF4444; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #0C3C78; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="app" class="p-4 max-w-xl mx-auto">
    <img src="icon.png" alt="Logo CEDAE" class="logo mb-4">

    <div id="notification" class="notification"></div>
    <div id="spinner" class="spinner hidden"></div>

    <div id="secao_abertura" class="section-card">
      <h2 class="section-title text-lg mb-4">1. Dados da Visita</h2>
      <div class="mb-4">
        <label for="avaliador" class="block text-sm font-medium text-gray-700">Avaliador (Seu Nome/ID)</label>
        <input type="text" id="avaliador" name="avaliador" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: João da Silva / 1234" required>
      </div>
      <div class="mb-4">
        <label for="local" class="block text-sm font-medium text-gray-700">Local da Visita (Unidade/Estação)</label>
        <input type="text" id="local" name="local" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: ETA Guandu" required>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">Localização (Mapa)</label>
        <div id="mapa_local"></div>
        <small class="text-gray-500">Localização atual ou padrão exibida.</small>
      </div>
      <button id="iniciar_formulario" class="w-full bg-blue-600 text-white btn py-2 hover:bg-blue-700">Iniciar Formulário</button>
    </div>

    <div id="secao_formulario" class="hidden">
      
      <div class="section-card">
        <h2 class="section-title text-lg">2. Roteiro de Avaliação</h2>
        <div class="mb-4">
          <label for="secao_select" class="block text-sm font-medium text-gray-700">Filtrar por Seção:</label>
          <select id="secao_select" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
            </select>
        </div>
        <div class="mb-4">
            <h3 class="text-sm font-medium text-gray-700">Progresso:</h3>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progresso" class="progress-bar h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <p id="progresso_texto" class="text-sm text-gray-600 mt-1">0 de 0 perguntas respondidas</p>
        </div>
      </div>
      
      <div id="perguntas_container">
        </div>

      <div class="section-card mt-6">
        <button id="finalizar_visita" class="w-full bg-green-600 text-white btn py-2 hover:bg-green-700 mb-3">Finalizar Visita e Revisar</button>
        <button id="baixar_excel" class="w-full bg-red-600 text-white btn py-2 hover:bg-red-700">Baixar Relatório Completo (ZIP)</button>
        <small class="text-gray-500 mt-2 block">Baixa um arquivo ZIP contendo o CSV e todas as fotos tiradas.</small>
      </div>
    </div>

    <div id="camera_modal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center p-4" style="z-index: 2000;">
      <div class="bg-white rounded-lg p-4 w-full max-w-lg">
        <h3 class="text-xl font-bold mb-3">Tirar Foto</h3>
        <div class="camera-container">
          <video id="camera_video" autoplay playsinline></video>
          <canvas id="camera_canvas" class="hidden"></canvas>
          <img id="photo_preview" class="photo-preview hidden">
          <div class="capture-btn-container">
            <button id="capture_photo" class="bg-blue-600 text-white btn p-3 rounded-full shadow-lg">Capturar</button>
            <button id="retake_photo" class="bg-yellow-500 text-white btn p-3 rounded-full shadow-lg hidden">Refazer</button>
          </div>
        </div>
        <div class="flex justify-between mt-3">
          <button id="cancel_camera" class="bg-gray-500 text-white btn py-2 px-4 hover:bg-gray-600">Cancelar</button>
          <button id="save_photo" class="bg-green-600 text-white btn py-2 px-4 hover:bg-green-700" disabled>Salvar Foto</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // Configurações e Estado Global
    const DB_NAME = 'VisitaTecnicaDB';
    const DB_VERSION = 1;
    const STORE_RESPOSTAS = 'RespostasFormulario';
    const STORE_PHOTOS = 'FotosVisitas';
    
    let db;
    let currentCameraInput = null;
    let capturedPhotoData = null;
    let lastPhotoId = 0;

    const APP_STATE = {
      avaliador: '',
      local: '',
      respostasFormulario: {} // Armazena todas as respostas do formulário
    };

    // NOVO ROTEIRO JSON COM CONDIÇÕES
    const ROTEIRO_JSON = [
      {"id":1,"secao":"Geral","pergunta":"Há presença ou vestígios da presença de animais domésticos na unidade?","tipoinput":"radio","opcao":"Sim;Não","condicao":"","pai":""},
      {"id":2,"secao":"Geral","pergunta":"Anexe evidências da presença de animais domésticos (potes de água, cama, o animal)","tipoinput":"file","opcao":"","condicao":"Sim","pai":"1"},
      {"id":3,"secao":"Geral","pergunta":"Houve ocorrência de algum acidente ambiental na unidade no período avaliado?","tipoinput":"radio","opcao":"Sim;Não","condicao":"","pai":""},
      {"id":4,"secao":"Geral","pergunta":"Anexe evidências do acidente ocorrido e uma descrição","tipoinput":"file","opcao":"","condicao":"Sim","pai":"3"},
      {"id":5,"secao":"Geral","pergunta":"descrição do acidente ocorrido","tipoinput":"textarea","opcao":"","condicao":"Sim","pai":"3"},
      {"id":6,"secao":"Geral","pergunta":"Faltam placas educativas e de identificação do manancial na unidade ou necessitando de substituição?","tipoinput":"radio","opcao":"Sim;Não","condicao":"","pai":""},
      {"id":7,"secao":"Geral","pergunta":"Em quais locais?","tipoinput":"textarea","opcao":"","condicao":"Sim","pai":"6"},
      {"id":8,"secao":"Geral","pergunta":"Anexe fotos das placas","tipoinput":"file","opcao":"","condicao":"Não","pai":"6"},
      {"id":9,"secao":"Geral","pergunta":"Foi verificada introdução ou plantação de espécie exótica de flora? Ex.: Limão, Mamão, Manga, Banana...","tipoinput":"radio","opcao":"Sim;Não","condicao":"","pai":""},
      {"id":10,"secao":"Geral","pergunta":"Evidência fotográfica:","tipoinput":"file","opcao":"","condicao":"Sim","pai":"9"},
      {"id":11,"secao":"Geral","pergunta":"Há utilização de equipamentos que consumam combustíveis fósseis?","tipoinput":"radio","opcao":"Sim;Não","condicao":"","pai":""},
      {"id":12,"secao":"Geral","pergunta":"Cite os equipamentos:","tipoinput":"textarea","opcao":"","condicao":"Sim","pai":"11"},
      {"id":13,"secao":"Energia","pergunta":"Qual a principal fonte de energia elétrica da unidade?","tipoinput":"checkboxGroup","opcao":"Elétrica concessionária;Fotovoltaica (solar)","condicao":"","pai":""},
      {"id":14,"secao":"Geradores","pergunta":"Há geradores na unidade?","tipoinput":"radio","opcao":"Sim;Não","condicao":"","pai":""},
      {"id":15,"secao":"Geradores","pergunta":"Para que são utilizados os geradores?","tipoinput":"textarea","opcao":"","condicao":"Sim","pai":"14"},
      {"id":16,"secao":"Geradores","pergunta":"Qual o combustível é utilizado?","tipoinput":"checkboxGroup","opcao":"Gasolina;Diesel;Etanol","condicao":"Sim","pai":"14"},
      {"id":17,"secao":"Armazenamento de combustíveis fósseis","pergunta":"Há armazenamento de combustível na unidade?","tipoinput":"radio","opcao":"Sim;Não","condicao":"","pai":""},
      {"id":18,"secao":"Armazenamento de combustíveis fósseis","pergunta":"Como os combustíveis são armazenados? (incluindo o tipo de recipiente, volume e o local).","tipoinput":"textarea","opcao":"","condicao":"Sim","pai":"17"},
      {"id":19,"secao":"Armazenamento de combustíveis fósseis","pergunta":"Há baia de contenção no local de armazenamento de combustíveis?","tipoinput":"radio","opcao":"Sim;Não","condicao":"","pai":""},
      {"id":20,"secao":"Armazenamento de combustíveis fósseis","pergunta":"Evidência fotográfica das baias de contenção:","tipoinput":"file","opcao":"","condicao":"Sim","pai":"19"},
      {"id":21,"secao":"Armazenamento de combustíveis fósseis","pergunta":"O piso do local de armazenamento de combustíveis é impermeável?","tipoinput":"radio","opcao":"Sim;Não","condicao":"","pai":""},
      {"id":22,"secao":"Armazenamento de combustíveis fósseis","pergunta":"Evidência fotográfica do piso impermeável:","tipoinput":"file","opcao":"","condicao":"Sim","pai":"21"},
      {"id":23,"secao":"Armazenamento de produtos químicos","pergunta":"Houve a transferência do tratamento químico da água captada para fora dos limites da Reserva Biológica?","tipoinput":"radio","opcao":"Sim;Não","condicao":"","pai":""},
      {"id":24,"secao":"Armazenamento de produtos químicos","pergunta":"Há tratamento químico da água na unidade?","tipoinput":"radio","opcao":"Sim;Não","condicao":"","pai":""},
      {"id":25,"secao":"Armazenamento de produtos químicos","pergunta":"Há armazenamento de produtos químicos na unidade?","tipoinput":"radio","opcao":"Sim;Não","condicao":"","pai":""},
      {"id":26,"secao":"Armazenamento de produtos químicos","pergunta":"Anexe imagem do armazenamento dos produtos químicos","tipoinput":"file","opcao":"","condicao":"Sim","pai":"24"},
      {"id":27,"secao":"Armazenamento de produtos químicos","pergunta":"Como os produtos químicos são armazenados? Qual a quantidade armazenada e o material do recipiente","tipoinput":"textarea","opcao":"","condicao":"Sim","pai":"24"},
      {"id":28,"secao":"Resíduos Sólidos","pergunta":"Há segregação de resíduos recicláveis e não recicláveis?","tipoinput":"radio","opcao":"Sim;Não","condicao":"","pai":""},
      {"id":29,"secao":"Resíduos Sólidos","pergunta":"Os residuos são acondicionados de forma adequada em contêineres identificados?","tipoinput":"radio","opcao":"Sim;Não","condicao":"","pai":""},
      {"id":30,"secao":"Resíduos Sólidos","pergunta":"Os residuos gerados são quantificados e seus pesos registrados?","tipoinput":"radio","opcao":"Sim;Não","condicao":"","pai":""},
      {"id":31,"secao":"Resíduos Sólidos","pergunta":"Anexo fotográfico do armazenamento dos resíduos até sua disposição final","tipoinput":"file","opcao":"","condicao":"","pai":""},
      {"id":32,"secao":"Resíduos Sólidos","pergunta":"Esta unidade é atendida pelo sistema público de coleta de resíduos?","tipoinput":"radio","opcao":"Sim;Não","condicao":"","pai":""},
      {"id":33,"secao":"Resíduos Sólidos","pergunta":"Como é realizada a disposição final dos resíduos sólidos não recicláveis gerados?","tipoinput":"textarea","opcao":"","condicao":"","pai":""},
      {"id":34,"secao":"Resíduos Sólidos","pergunta":"Foi verificado algum indício de queima de resíduos sólidos na unidade?","tipoinput":"radio","opcao":"Sim;Não","condicao":"","pai":""},
      {"id":35,"secao":"Resíduos Sólidos","pergunta":"Evidência de queima de residuos","tipoinput":"file","opcao":"","condicao":"Sim","pai":"34"},
      {"id":36,"secao":"Resíduos Sólidos","pergunta":"Há geração de resíduos perigosos na unidade?","tipoinput":"checkboxGroup","opcao":"Lâmpadas fluorescentes;Pilhas e baterias;Óleo lubrificante usado;Tintas;Outros;Não","condicao":"","pai":""},
      {"id":37,"secao":"Resíduos Sólidos","pergunta":"Se outros, Quais?","tipoinput":"textarea","opcao":"","condicao":"Outros","pai":"36"},
      {"id":38,"secao":"Resíduos Sólidos","pergunta":"Como é feito o descarte dos resíduos perigosos?","tipoinput":"textarea","opcao":"","condicao":"","pai":""},
      {"id":39,"secao":"Resíduos Sólidos","pergunta":"É possível identificar resíduos dispostos inadequadamente pelo terreno da unidade?","tipoinput":"checkboxGroup","opcao":"Entulhos e res. de obras; Sucatas/ bens inservíveis; Lixo comum; Outros;Não","condicao":"","pai":""},
      {"id":40,"secao":"Resíduos Sólidos","pergunta":"Caso outros, quais?","tipoinput":"textarea","opcao":"","condicao":"Outros","pai":"39"},
      {"id":41,"secao":"Resíduos Sólidos","pergunta":"Registro fotográfico ","tipoinput":"file","opcao":"","condicao":"","pai":""}
    ];

    // Funções de Utilidade
    function showNotification(message, type) {
      const el = document.getElementById('notification');
      el.textContent = message;
      el.className = `notification ${type}`;
      el.style.opacity = 1;
      setTimeout(() => { el.style.opacity = 0; }, 4000);
    }

    function showSpinner() {
      document.getElementById('spinner').classList.remove('hidden');
    }

    function hideSpinner() {
      document.getElementById('spinner').classList.add('hidden');
    }

    // Gerenciamento do IndexedDB
    async function initIndexedDB() {
      return new Promise((resolve) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = (event) => {
          console.error("Erro ao abrir IndexedDB", event);
          showNotification("Erro ao abrir IndexedDB. O modo offline pode falhar.", 'error');
          resolve(false);
        };
        request.onsuccess = (event) => {
          db = event.target.result;
          resolve(true);
        };
        request.onupgradeneeded = (event) => {
          db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_RESPOSTAS)) {
            db.createObjectStore(STORE_RESPOSTAS, { keyPath: 'id' });
          }
          if (!db.objectStoreNames.contains(STORE_PHOTOS)) {
            const store = db.createObjectStore(STORE_PHOTOS, { keyPath: 'id' });
            store.createIndex("id", "id", { unique: true });
          }
        };
      });
    }
    
    // Função para buscar o ID da última foto
    function getLastPhotoId() {
      return new Promise((resolve) => {
        if (!db) return resolve(0);
        const tx = db.transaction([STORE_PHOTOS], 'readonly');
        const store = tx.objectStore(STORE_PHOTOS);
        // Pega o maior ID da store
        const request = store.openCursor(null, 'prev'); 
        request.onsuccess = (e) => {
          const cursor = e.target.result;
          if (cursor) {
            resolve(parseInt(cursor.key, 10));
          } else {
            resolve(0);
          }
        };
        request.onerror = () => resolve(0);
      });
    }

    // Salvar e Carregar Respostas
    function saveAppState() {
      if (!db) return;
      
      // Salva metadados
      localStorage.setItem('APP_STATE_METADATA', JSON.stringify({ avaliador: APP_STATE.avaliador, local: APP_STATE.local }));

      // Salva respostas no IndexedDB
      const tx = db.transaction([STORE_RESPOSTAS], 'readwrite');
      const store = tx.objectStore(STORE_RESPOSTAS);
      
      const dataToSave = { 
        id: 'respostas', 
        respostas: APP_STATE.respostasFormulario 
      };
      
      store.put(dataToSave);
    }
    
    function loadAppState() {
        // Carrega metadados do LocalStorage
        const metadata = localStorage.getItem('APP_STATE_METADATA');
        if (metadata) {
            const parsedMetadata = JSON.parse(metadata);
            APP_STATE.avaliador = parsedMetadata.avaliador || '';
            APP_STATE.local = parsedMetadata.local || '';
            document.getElementById('avaliador').value = APP_STATE.avaliador;
            document.getElementById('local').value = APP_STATE.local;
        }

        // Carrega respostas do IndexedDB
        if (!db) return;
        const tx = db.transaction([STORE_RESPOSTAS], 'readonly');
        const store = tx.objectStore(STORE_RESPOSTAS);
        const request = store.get('respostas');
        
        request.onsuccess = (event) => {
            const data = event.target.result;
            if (data && data.respostas) {
                APP_STATE.respostasFormulario = data.respostas;
                // Aplica as respostas aos inputs
                applyAnswersToForm();
            }
        };
    }
    
    function applyAnswersToForm() {
        Object.keys(APP_STATE.respostasFormulario).forEach(inputId => {
            const value = APP_STATE.respostasFormulario[inputId];
            const input = document.getElementById(inputId);
            
            if (input) {
                if (input.type === 'radio') {
                    const radio = document.querySelector(`input[name="${inputId}"][value="${value}"]`);
                    if (radio) radio.checked = true;
                } else if (input.classList.contains('camera-input')) {
                    const container = input.closest('.flex') || input.closest('.input-area');
                    if (container) {
                        const infoEl = container.querySelector('.photo-info');
                        if(infoEl) infoEl.textContent = `Foto Salva: ID ${value}`;
                    }
                } else if (input.type === 'hidden' && document.querySelector(`input[name="${inputId}"][type="checkbox"]`)) {
                    // Trata o caso de checkboxGroup
                    const existingOptions = value.split(';');
                    document.querySelectorAll(`input[name="${inputId}"][type="checkbox"]`).forEach(checkbox => {
                        checkbox.checked = existingOptions.includes(checkbox.value);
                    });
                } else {
                    input.value = value;
                }
            }
        });
        // Após carregar os dados, re-aplica a visibilidade condicional
        document.querySelectorAll('.pergunta-card[data-pai]').forEach(card => {
            const parentId = card.dataset.pai;
            const parentInput = document.getElementById(parentId);
            if (parentInput) {
                // Tenta pegar o valor salvo, ou o valor atual se for radio (que não usa o input ID como campo de valor)
                const parentValue = APP_STATE.respostasFormulario[parentId] || (parentInput.type === 'radio' && document.querySelector(`input[name="${parentId}"]:checked`) ? document.querySelector(`input[name="${parentId}"]:checked`).value : parentInput.value);
                checkConditionalVisibility(parentId, parentValue);
            }
        });
        updateProgress();
    }

    // Lógica Condicional: Exibe ou oculta perguntas baseadas na resposta pai
    function checkConditionalVisibility(parentInputId, parentValue) {
        // Encontra todas as perguntas que dependem do pai
        document.querySelectorAll(`.pergunta-card[data-pai="${parentInputId}"]`).forEach(card => {
            const condicao = card.dataset.condicao;
            const inputId = card.querySelector('.input-area').dataset.inputId;
            let isVisible = false;

            // Checa se a resposta do pai (parentValue) inclui a condição necessária
            if (parentValue && parentValue.includes(condicao)) {
                isVisible = true;
            }
            
            if (isVisible) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
                
                // Limpa a resposta do campo oculto
                if (APP_STATE.respostasFormulario[inputId]) {
                    delete APP_STATE.respostasFormulario[inputId];
                    
                    const inputElement = document.getElementById(inputId);
                    if (inputElement) inputElement.value = '';
                    
                    document.querySelectorAll(`input[name="${inputId}"]`).forEach(el => {
                        if(el.type === 'radio' || el.type === 'checkbox') el.checked = false;
                    });
                }
            }
            
            // Re-aplica o filtro de seção, se estiver ativo
            const selectedSecao = document.getElementById('secao_select').value;
            if(selectedSecao !== '' && card.dataset.secao !== selectedSecao && isVisible){
                card.style.display = 'none';
            }
        });
        updateProgress();
    }


    // Geração do Formulário e Lógica
    function generateForm() {
      const container = document.getElementById('perguntas_container');
      container.innerHTML = '';
      
      ROTEIRO_JSON.forEach(p => {
        const inputId = `pergunta_${p.id}`;
        const card = document.createElement('div');
        card.className = 'section-card pergunta-card';
        card.dataset.secao = p.secao;
        
        // Adiciona atributos para a lógica condicional
        if (p.pai) {
            card.dataset.pai = `pergunta_${p.pai}`; // ID do input pai (ex: pergunta_1)
            card.dataset.condicao = p.condicao;      // Valor que deve ser correspondido (ex: Sim)
            card.style.display = 'none'; // Esconde por padrão
        }
        
        const content = `
          <p class="font-bold text-gray-800 mb-2">${p.id}. ${p.pergunta}</p>
          <div class="input-area" data-input-id="${inputId}">
            ${renderInput(p, inputId)}
          </div>
        `;
        card.innerHTML = content;
        container.appendChild(card);
      });
      
      applyAnswersToForm(); // Aplica respostas e ajusta visibilidade
    }
    
    function renderInput(p, inputId) {
      const existingValue = APP_STATE.respostasFormulario[inputId] || '';
      const tipo = p.tipoinput;
      const opcoes = p.opcao ? p.opcao.split(';') : [];

      switch (tipo) {
        case 'radio':
          return opcoes.map(opt => `
            <div class="flex items-center">
              <input id="${inputId}_${opt}" name="${inputId}" type="radio" value="${opt}" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" ${existingValue === opt ? 'checked' : ''}>
              <label for="${inputId}_${opt}" class="ml-2 block text-sm text-gray-900">${opt}</label>
            </div>
          `).join('');
        
        case 'checkboxGroup':
            // O valor do APP_STATE é uma string separada por ';'
            const existingOptions = existingValue.split(';'); 
            return opcoes.map(opt => `
                <div class="flex items-center">
                    <input id="${inputId}_${opt}" name="${inputId}" type="checkbox" value="${opt}" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 checkbox-group-input" ${existingOptions.includes(opt) ? 'checked' : ''}>
                    <label for="${inputId}_${opt}" class="ml-2 block text-sm text-gray-900">${opt}</label>
                </div>
            `).join('');

        case 'textarea':
          return `<textarea id="${inputId}" name="${inputId}" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md p-2">${existingValue}</textarea>`;
        case 'number':
        case 'date':
          return `<input type="${tipo}" id="${inputId}" name="${inputId}" class="mt-1 block w-full border border-gray-300 rounded-md p-2" value="${existingValue}">`;
          
        case 'file': // Tratado como Câmera/Photo
          const photoInfoText = existingValue ? `Foto Salva: ID ${existingValue}` : 'Nenhuma foto salva';
          return `
            <div class="flex items-center justify-between mt-2">
              <button type="button" class="bg-indigo-600 text-white btn py-2 px-4 hover:bg-indigo-700 open-camera-btn" data-input-id="${inputId}">
                Abrir Câmera
              </button>
              <span class="text-sm text-gray-600 photo-info">${photoInfoText}</span>
              <input type="hidden" id="${inputId}" class="camera-input" value="${existingValue}">
            </div>
          `;
        default:
          return '';
      }
    }
    
    function updateProgress() {
      const total = ROTEIRO_JSON.length;
      // Considera respondidas apenas as perguntas visíveis ou as que não são condicionais
      const respondidas = ROTEIRO_JSON.filter(p => {
        const inputId = `pergunta_${p.id}`;
        const resposta = APP_STATE.respostasFormulario[inputId];
        
        // Verifica se a resposta não está vazia (incluindo 0 para campos numéricos ou IDs de foto)
        const isAnswered = String(resposta).trim() !== '' && String(resposta).trim() !== 'undefined';
        
        if (isAnswered) {
            return true;
        }

        // Para os tipos não respondidos, se eles são condicionais e não visíveis, não contam para o total
        if (p.pai) {
            const parentInputId = `pergunta_${p.pai}`;
            const parentQuestion = ROTEIRO_JSON.find(q => q.id === p.pai);
            const parentValue = APP_STATE.respostasFormulario[parentInputId];

            // Se a pergunta pai tem valor, e esse valor NÃO atende à condição, a pergunta filha não é contada
            if (parentValue && !parentValue.includes(p.condicao)) {
                return false;
            }
        }
        
        // Se não foi respondida, e é visível (ou não condicional), não está completa.
        return false;

      }).length;
      
      const percent = total > 0 ? (respondidas / total) * 100 : 0;
      
      document.getElementById('progresso').style.width = `${percent}%`;
      document.getElementById('progresso_texto').textContent = `${respondidas} de ${total} perguntas respondidas`;
    }

    // Lógica da Câmera
    function openCamera(inputId) {
      currentCameraInput = inputId;
      document.getElementById('camera_modal').classList.remove('hidden');
      
      const video = document.getElementById('camera_video');
      const preview = document.getElementById('photo_preview');
      const captureBtn = document.getElementById('capture_photo');
      const retakeBtn = document.getElementById('retake_photo');
      const saveBtn = document.getElementById('save_photo');
      
      // Limpar estados anteriores
      preview.classList.add('hidden');
      video.classList.remove('hidden');
      captureBtn.classList.remove('hidden');
      retakeBtn.classList.add('hidden');
      saveBtn.disabled = true;
      capturedPhotoData = null;

      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }) // Câmera traseira
          .then(stream => {
            video.srcObject = stream;
            video.play();
          })
          .catch(err => {
            console.error("Erro ao acessar a câmera: ", err);
            showNotification("Erro: Não foi possível acessar a câmera. É necessário HTTPS/PWA.", 'error');
            closeCameraModal();
          });
      } else {
        showNotification("Câmera não suportada neste navegador.", 'error');
        closeCameraModal();
      }
    }
    
    function capturePhoto() {
      const video = document.getElementById('camera_video');
      const canvas = document.getElementById('camera_canvas');
      const preview = document.getElementById('photo_preview');
      const captureBtn = document.getElementById('capture_photo');
      const retakeBtn = document.getElementById('retake_photo');
      const saveBtn = document.getElementById('save_photo');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // Converte o frame da foto para Base64 (JPEG é o ideal para fotos)
      capturedPhotoData = canvas.toDataURL('image/jpeg', 0.8); 
      
      // Mostrar prévia
      preview.src = capturedPhotoData;
      preview.classList.remove('hidden');
      video.classList.add('hidden');
      
      // Esconder/Mostrar botões
      captureBtn.classList.add('hidden');
      retakeBtn.classList.remove('hidden');
      saveBtn.disabled = false;
    }
    
    async function savePhotoAndClose() {
      if (!capturedPhotoData || !currentCameraInput) {
        showNotification("Nenhuma foto capturada para salvar.", 'error');
        return;
      }
      
      try {
        // Incrementa o ID da última foto
        lastPhotoId++;
        const newPhotoId = String(lastPhotoId).padStart(3, '0');
        
        // Salva a foto no IndexedDB
        const tx = db.transaction([STORE_PHOTOS], 'readwrite');
        const store = tx.objectStore(STORE_PHOTOS);
        
        const photoRecord = {
          id: newPhotoId, // ex: "001", "002"
          data: capturedPhotoData, // string Base64 da imagem
          timestamp: new Date().toISOString(),
          local: APP_STATE.local,
          avaliador: APP_STATE.avaliador
        };
        
        store.put(photoRecord);
        
        // Atualiza a resposta no formulário com o ID da foto
        const inputElement = document.getElementById(currentCameraInput);
        if (inputElement) {
          inputElement.value = newPhotoId;
          APP_STATE.respostasFormulario[currentCameraInput] = newPhotoId;
          
          // Atualiza o texto de informação
          const container = inputElement.closest('.flex') || inputElement.closest('.input-area');
          if (container) {
            const infoEl = container.querySelector('.photo-info');
            if(infoEl) infoEl.textContent = `Foto Salva: ID ${newPhotoId}`;
          }
        }
        
        saveAppState();
        showNotification(`Foto salva com sucesso! ID: ${newPhotoId}`, 'success');
        
      } catch (e) {
        console.error("Erro ao salvar foto:", e);
        showNotification("Erro ao salvar foto no banco de dados.", 'error');
      } finally {
        closeCameraModal();
      }
    }

    function closeCameraModal() {
      const video = document.getElementById('camera_video');
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
      }
      document.getElementById('camera_modal').classList.add('hidden');
      currentCameraInput = null;
      capturedPhotoData = null;
    }
    
    // Funções de Download (ZIP)
    
    // Auxiliar para buscar todas as fotos
    function getAllPhotos() {
      return new Promise((resolve, reject) => {
        if (!db) return reject(new Error('IndexedDB não disponível'));
        const tx = db.transaction([STORE_PHOTOS], 'readonly');
        const store = tx.objectStore(STORE_PHOTOS);
        const request = store.getAll();
        request.onsuccess = (e) => resolve(e.target.result);
        request.onerror = (e) => reject(new Error('Erro ao buscar fotos do IndexedDB.'));
      });
    }

    // Função principal para baixar o ZIP
    async function downloadReportZip() {
      if(Object.keys(APP_STATE.respostasFormulario).length === 0){
        showNotification('O formulário está vazio. Preencha pelo menos uma resposta para baixar o relatório.', 'error');
        return;
      }
      
      showSpinner();
      try {
        const zip = new JSZip();
        const photos = await getAllPhotos(); // Busca todas as fotos salvas

        // 1. CONSTRUÇÃO DO CSV
        const BOM = '\ufeff'; // Byte Order Mark para compatibilidade com acentuação no Excel
        const headers = ["Secao", "Pergunta", "Resposta", "Avaliador", "Local", "Data_Exportacao"];
        
        const reportRows = ROTEIRO_JSON.map(p => {
          const inputId = `pergunta_${p.id}`;
          const resposta = APP_STATE.respostasFormulario[inputId] || ''; 
          
          // Adiciona aspas em todos os campos para evitar problemas com vírgulas no texto
          return [
            `"${p.secao}"`, 
            `"${p.pergunta.replace(/"/g, '""')}"`, 
            `"${String(resposta).replace(/"/g, '""')}"`, 
            `"${APP_STATE.avaliador.replace(/"/g, '""')}"`, 
            `"${APP_STATE.local.replace(/"/g, '""')}"`, 
            `"${new Date().toLocaleString('pt-BR')}"`
          ].join(',');
        });
        
        const csvContent = headers.join(',') + '\n' + reportRows.join('\n');
        const finalCSV = BOM + csvContent;

        // Adiciona o CSV ao ZIP
        const localNome = APP_STATE.local.replace(/[^a-zA-Z0-9]/g, '_') || 'visita';
        zip.file(`relatorio_${localNome}.csv`, finalCSV);

        // 2. ADICIONAR AS FOTOS AO ZIP
        // Filtra as respostas para obter apenas os IDs de foto usados no formulário
        const usedPhotoIds = new Set(Object.values(APP_STATE.respostasFormulario).filter(v => 
             typeof v === 'string' && v.length <= 5 && !isNaN(v) && v !== ''
        ));
        
        photos.forEach(photo => {
          if (usedPhotoIds.has(photo.id)) {
            // Remove o cabeçalho "data:image/jpeg;base64," para obter apenas a string base64
            const base64Data = photo.data.split(',')[1];
            
            // Adiciona ao ZIP como um arquivo JPEG binário. Base64: true indica que a string é base64
            zip.file(`${photo.id}.jpg`, base64Data, { base64: true });
          }
        });

        // 3. GERAÇÃO E DOWNLOAD DO ZIP
        const zipBlob = await zip.generateAsync({ type: "blob" });
        const url = URL.createObjectURL(zipBlob);
        
        const link = document.createElement('a');
        link.setAttribute('href', url);
        const dateString = new Date().toISOString().slice(0, 10);
        const filename = `relatorio_completo_${localNome}_${dateString}.zip`;
        link.setAttribute('download', filename);

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url); // Limpeza da URL Blob

        showNotification('Arquivo ZIP (CSV + Fotos) gerado com sucesso!','success');

      } catch (e) {
        console.error('Erro ao gerar ZIP:', e);
        showNotification(`Erro ao gerar ZIP: ${e.message}`, 'error');
      } finally {
        hideSpinner();
      }
    }


    // Gerenciamento de Eventos e Inicialização
    function setupAppListeners() {
      // Listener para a Seção de Abertura
      document.getElementById('iniciar_formulario').addEventListener('click', () => {
        const avaliador = document.getElementById('avaliador').value.trim();
        const local = document.getElementById('local').value.trim();
        
        if (avaliador === '' || local === '') {
          showNotification('Preencha o Avaliador e o Local da Visita para continuar.', 'error');
          return;
        }
        
        APP_STATE.avaliador = avaliador;
        APP_STATE.local = local;
        saveAppState();
        
        document.getElementById('secao_abertura').classList.add('hidden');
        document.getElementById('secao_formulario').classList.remove('hidden');
        generateForm();
      });
      
      // Listener para o Filtro de Seção
      document.getElementById('secao_select').addEventListener('change', (e) => {
        const selectedSecao = e.target.value;
        document.querySelectorAll('.pergunta-card').forEach(card => {
            const isConditionalHidden = card.dataset.pai && card.style.display === 'none';
            
            if (selectedSecao === '' || card.dataset.secao === selectedSecao) {
                // Só exibe se não estiver oculto pela lógica condicional
                if(!isConditionalHidden) {
                    card.style.display = 'block';
                }
            } else {
                card.style.display = 'none';
            }
        });
      });
      
      // Listener de eventos de input no formulário (Delegation)
      document.getElementById('perguntas_container').addEventListener('input', (e) => {
        const target = e.target;
        const inputId = target.name || target.id;
        
        if (inputId.startsWith('pergunta_') && target.type !== 'file' && target.type !== 'hidden') {
          let value;
          
          if (target.type === 'radio' || target.type === 'textarea' || target.type === 'number' || target.type === 'date') {
              value = target.value;
          } else if (target.type === 'checkbox') {
              // Para checkbox, o valor é uma string de todos os checados separados por ';'
              const checkboxGroup = document.querySelectorAll(`input[name="${target.name}"]:checked`);
              value = Array.from(checkboxGroup).map(cb => cb.value).join(';');
          } else {
              return; // Ignora outros tipos
          }

          APP_STATE.respostasFormulario[inputId] = value;
          saveAppState();
          updateProgress();
          
          // Checagem condicional após a mudança do input
          checkConditionalVisibility(inputId, value);
        }
      });
      
      // Listener para abrir a câmera
      document.getElementById('perguntas_container').addEventListener('click', (e) => {
        if (e.target.classList.contains('open-camera-btn')) {
          e.preventDefault();
          const inputId = e.target.dataset.inputId;
          openCamera(inputId);
        }
      });
      
      // Listeners do Modal da Câmera
      document.getElementById('capture_photo').addEventListener('click', capturePhoto);
      document.getElementById('retake_photo').addEventListener('click', () => openCamera(currentCameraInput));
      document.getElementById('save_photo').addEventListener('click', savePhotoAndClose);
      document.getElementById('cancel_camera').addEventListener('click', closeCameraModal);
      
      // Listener para o botão de Download (ZIP)
      document.getElementById('baixar_excel').addEventListener('click', downloadReportZip);
      
      // Listener de Finalizar
      document.getElementById('finalizar_visita').addEventListener('click', () => {
        showNotification('Visita Finalizada! Baixe o relatório completo (ZIP) para enviar.','success');
      });
      
      // Listener de metadados
      document.getElementById('avaliador').addEventListener('input', (e) => {
          APP_STATE.avaliador = e.target.value.trim();
          saveAppState();
      });
      document.getElementById('local').addEventListener('input', (e) => {
          APP_STATE.local = e.target.value.trim();
          saveAppState();
      });
    }

    async function initApp(){
      await initIndexedDB();
      loadAppState();
      
      lastPhotoId = await getLastPhotoId(); 
      
      // Prepara o seletor de seção
      const secoes = [...new Set(ROTEIRO_JSON.map(p=>p.secao))];
      const selectEl = document.getElementById('secao_select');
      selectEl.innerHTML = '<option value="">-- Todas as Seções --</option>';
      secoes.forEach(sec=>{ 
        const opt = document.createElement('option'); 
        opt.value = sec; 
        opt.textContent = sec; 
        selectEl.appendChild(opt); 
      });

      // Inicializa o mapa (Leaflet)
      const defaultLat = -22.9035; 
      const defaultLng = -43.2096;
      const mapa = L.map('mapa_local').setView([defaultLat, defaultLng], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(mapa);
      L.marker([defaultLat, defaultLng]).addTo(mapa).bindPopup('Local da Visita (Padrão)').openPopup();
      
      if(navigator.geolocation){ 
        navigator.geolocation.getCurrentPosition(pos=>{ 
          const {latitude,longitude} = pos.coords; 
          mapa.setView([latitude,longitude],14); 
          L.marker([latitude,longitude]).addTo(mapa).bindPopup('Sua Posição Atual').openPopup(); 
        }, (err)=>{ 
          console.warn('Geolocation falhou', err.message); 
        }); 
      }

      setupAppListeners();
      
      if (APP_STATE.avaliador && APP_STATE.local) {
        document.getElementById('secao_abertura').classList.add('hidden');
        document.getElementById('secao_formulario').classList.remove('hidden');
        generateForm();
      }
    }

    window.addEventListener('load', initApp);
    
    // Serviço de worker para offline
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => console.log('Service Worker registrado com sucesso: ', reg.scope))
          .catch(err => console.log('Falha no registro do Service Worker: ', err));
      });
    }
    
  </script>

</body>
</html>
