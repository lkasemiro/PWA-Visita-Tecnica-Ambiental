<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Formul√°rio T√©cnico CEDAE (Offline)</title>
  <meta name="theme-color" content="#0C3C78">
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  
  <style>
    /* Estilos do c√≥digo original */
    body { background-color: #f8f9fa; margin:0; padding:0; font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .logo { width:100%; max-width:180px; margin:10px auto; display:block }
    .btn { font-weight:600; border-radius:8px }
    .section-card{ background:white; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.08); margin-bottom:20px; padding:15px }
    .section-title{ color:#0C3C78; font-weight:700; margin-bottom:10px }
    .progress-bar{ background-color:#51C751 }
    #mapa_local{ height: 200px; border-radius: 8px; margin-top: 10px; }
    .hidden { display: none; }
    
    /* Estilos para a C√¢mera (mantidos para funcionalidade) */
    .camera-container { position: relative; width: 100%; height: 300px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 8px; overflow: hidden;}
    video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
    .capture-btn-container { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 10;}
    .photo-preview { max-width: 100%; max-height: 280px; margin-top: 10px; border-radius: 8px; object-fit: contain; }
    
    /* Estilos para Notifica√ß√£o e Spinner (mantidos para feedback) */
    .notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 8px; color: white; z-index: 1000; transition: opacity 0.3s; opacity: 0; }
    .notification.success { background-color: #51C751; }
    .notification.error { background-color: #EF4444; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #0C3C78; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="app" class="p-4 max-w-xl mx-auto">
    <img src="icon.png" alt="Logo CEDAE" class="logo mb-4">

    <div id="notification" class="notification"></div>
    <div id="spinner" class="spinner hidden"></div>

    <div id="secao_abertura" class="section-card">
      <h2 class="section-title text-lg mb-4">1. Dados da Visita</h2>
      <div class="mb-4">
        <label for="avaliador" class="block text-sm font-medium text-gray-700">Avaliador (Seu Nome/ID)</label>
        <input type="text" id="avaliador" name="avaliador" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Jo√£o da Silva / 1234" required>
      </div>
      <div class="mb-4">
        <label for="local" class="block text-sm font-medium text-gray-700">Local da Visita (Unidade/Esta√ß√£o)</label>
        <input type="text" id="local" name="local" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: ETA Guandu" required>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">Localiza√ß√£o (Mapa)</label>
        <div id="mapa_local"></div>
        <small class="text-gray-500">Localiza√ß√£o atual ou padr√£o exibida.</small>
      </div>
      <button id="iniciar_formulario" class="w-full bg-blue-600 text-white btn py-2 hover:bg-blue-700">Iniciar Formul√°rio</button>
    </div>

    <div id="secao_formulario" class="hidden">
      
      <div class="section-card">
        <h2 class="section-title text-lg">2. Roteiro de Avalia√ß√£o</h2>
        <div class="mb-4">
          <label for="secao_select" class="block text-sm font-medium text-gray-700">Filtrar por Se√ß√£o:</label>
          <select id="secao_select" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
            </select>
        </div>
        <div class="mb-4">
            <h3 class="text-sm font-medium text-gray-700">Progresso:</h3>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progresso" class="progress-bar h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <p id="progresso_texto" class="text-sm text-gray-600 mt-1">0 de 0 perguntas respondidas</p>
        </div>
      </div>
      
      <div id="perguntas_container">
        </div>

      <div class="section-card mt-6">
        <button id="finalizar_visita" class="w-full bg-green-600 text-white btn py-2 hover:bg-green-700 mb-3">Finalizar Visita e Revisar</button>
        <button id="baixar_excel" class="w-full bg-red-600 text-white btn py-2 hover:bg-red-700">Baixar Relat√≥rio Completo (ZIP)</button>
        <small class="text-gray-500 mt-2 block">Baixa um arquivo ZIP contendo o CSV e todas as fotos tiradas.</small>
      </div>
    </div>

    <div id="camera_modal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center p-4" style="z-index: 2000;">
      <div class="bg-white rounded-lg p-4 w-full max-w-lg">
        <h3 class="text-xl font-bold mb-3">Tirar Foto</h3>
        <div class="camera-container">
          <video id="camera_video" autoplay playsinline></video>
          <canvas id="camera_canvas" class="hidden"></canvas>
          <img id="photo_preview" class="photo-preview hidden">
          <div class="capture-btn-container">
            <button id="capture_photo" class="bg-blue-600 text-white btn p-3 rounded-full shadow-lg">Capturar</button>
            <button id="retake_photo" class="bg-yellow-500 text-white btn p-3 rounded-full shadow-lg hidden">Refazer</button>
          </div>
        </div>
        <div class="flex justify-between mt-3">
          <button id="cancel_camera" class="bg-gray-500 text-white btn py-2 px-4 hover:bg-gray-600">Cancelar</button>
          <button id="save_photo" class="bg-green-600 text-white btn py-2 px-4 hover:bg-green-700" disabled>Salvar Foto</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // Configura√ß√µes e Estado Global
    const DB_NAME = 'VisitaTecnicaDB';
    const DB_VERSION = 1;
    const STORE_RESPOSTAS = 'RespostasFormulario';
    const STORE_PHOTOS = 'FotosVisitas';
    
    let db;
    let currentCameraInput = null;
    let capturedPhotoData = null;
    let lastPhotoId = 0;

    const APP_STATE = {
      avaliador: '',
      local: '',
      respostasFormulario: {} // Armazena todas as respostas do formul√°rio
    };

    // üåü NOVO ROTEIRO JSON COM CONDI√á√ïES üåü
    const ROTEIRO_JSON = [
      {"id":1,"secao":"Geral","pergunta":"H√° presen√ßa ou vest√≠gios da presen√ßa de animais dom√©sticos na unidade?","tipoinput":"radio","opcao":"Sim;N√£o","condicao":"","pai":""},
      {"id":2,"secao":"Geral","pergunta":"Anexe evid√™ncias da presen√ßa de animais dom√©sticos (potes de √°gua, cama, o animal)","tipoinput":"file","opcao":"","condicao":"Sim","pai":"1"},
      {"id":3,"secao":"Geral","pergunta":"Houve ocorr√™ncia de algum acidente ambiental na unidade no per√≠odo avaliado?","tipoinput":"radio","opcao":"Sim;N√£o","condicao":"","pai":""},
      {"id":4,"secao":"Geral","pergunta":"Anexe evid√™ncias do acidente ocorrido e uma descri√ß√£o","tipoinput":"file","opcao":"","condicao":"Sim","pai":"3"},
      {"id":5,"secao":"Geral","pergunta":"descri√ß√£o do acidente ocorrido","tipoinput":"textarea","opcao":"","condicao":"Sim","pai":"3"},
      {"id":6,"secao":"Geral","pergunta":"Faltam placas educativas e de identifica√ß√£o do manancial na unidade ou necessitando de substitui√ß√£o?","tipoinput":"radio","opcao":"Sim;N√£o","condicao":"","pai":""},
      {"id":7,"secao":"Geral","pergunta":"Em quais locais?","tipoinput":"textarea","opcao":"","condicao":"Sim","pai":"6"},
      {"id":8,"secao":"Geral","pergunta":"Anexe fotos das placas","tipoinput":"file","opcao":"","condicao":"N√£o","pai":"6"},
      {"id":9,"secao":"Geral","pergunta":"Foi verificada introdu√ß√£o ou planta√ß√£o de esp√©cie ex√≥tica de flora? Ex.: Lim√£o, Mam√£o, Manga, Banana...","tipoinput":"radio","opcao":"Sim;N√£o","condicao":"","pai":""},
      {"id":10,"secao":"Geral","pergunta":"Evid√™ncia fotogr√°fica:","tipoinput":"file","opcao":"","condicao":"Sim","pai":"9"},
      {"id":11,"secao":"Geral","pergunta":"H√° utiliza√ß√£o de equipamentos que consumam combust√≠veis f√≥sseis?","tipoinput":"radio","opcao":"Sim;N√£o","condicao":"","pai":""},
      {"id":12,"secao":"Geral","pergunta":"Cite os equipamentos:","tipoinput":"textarea","opcao":"","condicao":"Sim","pai":"11"},
      {"id":13,"secao":"Energia","pergunta":"Qual a principal fonte de energia el√©trica da unidade?","tipoinput":"checkboxGroup","opcao":"El√©trica concession√°ria;Fotovoltaica (solar)","condicao":"","pai":""},
      {"id":14,"secao":"Geradores","pergunta":"H√° geradores na unidade?","tipoinput":"radio","opcao":"Sim;N√£o","condicao":"","pai":""},
      {"id":15,"secao":"Geradores","pergunta":"Para que s√£o utilizados os geradores?","tipoinput":"textarea","opcao":"","condicao":"Sim","pai":"14"},
      {"id":16,"secao":"Geradores","pergunta":"Qual o combust√≠vel √© utilizado?","tipoinput":"checkboxGroup","opcao":"Gasolina;Diesel;Etanol","condicao":"Sim","pai":"14"},
      {"id":17,"secao":"Armazenamento de combust√≠veis f√≥sseis","pergunta":"H√° armazenamento de combust√≠vel na unidade?","tipoinput":"radio","opcao":"Sim;N√£o","condicao":"","pai":""},
      {"id":18,"secao":"Armazenamento de combust√≠veis f√≥sseis","pergunta":"Como os combust√≠veis s√£o armazenados? (incluindo o tipo de recipiente, volume e o local).","tipoinput":"textarea","opcao":"","condicao":"Sim","pai":"17"},
      {"id":19,"secao":"Armazenamento de combust√≠veis f√≥sseis","pergunta":"H√° baia de conten√ß√£o no local de armazenamento de combust√≠veis?","tipoinput":"radio","opcao":"Sim;N√£o","condicao":"","pai":""},
      {"id":20,"secao":"Armazenamento de combust√≠veis f√≥sseis","pergunta":"Evid√™ncia fotogr√°fica das baias de conten√ß√£o:","tipoinput":"file","opcao":"","condicao":"Sim","pai":"19"},
      {"id":21,"secao":"Armazenamento de combust√≠veis f√≥sseis","pergunta":"O piso do local de armazenamento de combust√≠veis √© imperme√°vel?","tipoinput":"radio","opcao":"Sim;N√£o","condicao":"","pai":""},
      {"id":22,"secao":"Armazenamento de combust√≠veis f√≥sseis","pergunta":"Evid√™ncia fotogr√°fica do piso imperme√°vel:","tipoinput":"file","opcao":"","condicao":"Sim","pai":"21"},
      {"id":23,"secao":"Armazenamento de produtos qu√≠micos","pergunta":"Houve a transfer√™ncia do tratamento qu√≠mico da √°gua captada para fora dos limites da Reserva Biol√≥gica?","tipoinput":"radio","opcao":"Sim;N√£o","condicao":"","pai":""},
      {"id":24,"secao":"Armazenamento de produtos qu√≠micos","pergunta":"H√° tratamento qu√≠mico da √°gua na unidade?","tipoinput":"radio","opcao":"Sim;N√£o","condicao":"","pai":""},
      {"id":25,"secao":"Armazenamento de produtos qu√≠micos","pergunta":"H√° armazenamento de produtos qu√≠micos na unidade?","tipoinput":"radio","opcao":"Sim;N√£o","condicao":"","pai":""},
      {"id":26,"secao":"Armazenamento de produtos qu√≠micos","pergunta":"Anexe imagem do armazenamento dos produtos qu√≠micos","tipoinput":"file","opcao":"","condicao":"Sim","pai":"24"},
      {"id":27,"secao":"Armazenamento de produtos qu√≠micos","pergunta":"Como os produtos qu√≠micos s√£o armazenados? Qual a quantidade armazenada e o material do recipiente","tipoinput":"textarea","opcao":"","condicao":"Sim","pai":"24"},
      {"id":28,"secao":"Res√≠duos S√≥lidos","pergunta":"H√° segrega√ß√£o de res√≠duos recicl√°veis e n√£o recicl√°veis?","tipoinput":"radio","opcao":"Sim;N√£o","condicao":"","pai":""},
      {"id":29,"secao":"Res√≠duos S√≥lidos","pergunta":"Os residuos s√£o acondicionados de forma adequada em cont√™ineres identificados?","tipoinput":"radio","opcao":"Sim;N√£o","condicao":"","pai":""},
      {"id":30,"secao":"Res√≠duos S√≥lidos","pergunta":"Os residuos gerados s√£o quantificados e seus pesos registrados?","tipoinput":"radio","opcao":"Sim;N√£o","condicao":"","pai":""},
      {"id":31,"secao":"Res√≠duos S√≥lidos","pergunta":"Anexo fotogr√°fico do armazenamento dos res√≠duos at√© sua disposi√ß√£o final","tipoinput":"file","opcao":"","condicao":"","pai":""},
      {"id":32,"secao":"Res√≠duos S√≥lidos","pergunta":"Esta unidade √© atendida pelo sistema p√∫blico de coleta de res√≠duos?","tipoinput":"radio","opcao":"Sim;N√£o","condicao":"","pai":""},
      {"id":33,"secao":"Res√≠duos S√≥lidos","pergunta":"Como √© realizada a disposi√ß√£o final dos res√≠duos s√≥lidos n√£o recicl√°veis gerados?","tipoinput":"textarea","opcao":"","condicao":"","pai":""},
      {"id":34,"secao":"Res√≠duos S√≥lidos","pergunta":"Foi verificado algum ind√≠cio de queima de res√≠duos s√≥lidos na unidade?","tipoinput":"radio","opcao":"Sim;N√£o","condicao":"","pai":""},
      {"id":35,"secao":"Res√≠duos S√≥lidos","pergunta":"Evid√™ncia de queima de residuos","tipoinput":"file","opcao":"","condicao":"Sim","pai":"34"},
      {"id":36,"secao":"Res√≠duos S√≥lidos","pergunta":"H√° gera√ß√£o de res√≠duos perigosos na unidade?","tipoinput":"checkboxGroup","opcao":"L√¢mpadas fluorescentes;Pilhas e baterias;√ìleo lubrificante usado;Tintas;Outros;N√£o","condicao":"","pai":""},
      {"id":37,"secao":"Res√≠duos S√≥lidos","pergunta":"Se outros, Quais?","tipoinput":"textarea","opcao":"","condicao":"Outros","pai":"36"},
      {"id":38,"secao":"Res√≠duos S√≥lidos","pergunta":"Como √© feito o descarte dos res√≠duos perigosos?","tipoinput":"textarea","opcao":"","condicao":"","pai":""},
      {"id":39,"secao":"Res√≠duos S√≥lidos","pergunta":"√â poss√≠vel identificar res√≠duos dispostos inadequadamente pelo terreno da unidade?","tipoinput":"checkboxGroup","opcao":"Entulhos e res. de obras; Sucatas/ bens inserv√≠veis; Lixo comum; Outros;N√£o","condicao":"","pai":""},
      {"id":40,"secao":"Res√≠duos S√≥lidos","pergunta":"Caso outros, quais?","tipoinput":"textarea","opcao":"","condicao":"Outros","pai":"39"},
      {"id":41,"secao":"Res√≠duos S√≥lidos","pergunta":"Registro fotogr√°fico ","tipoinput":"file","opcao":"","condicao":"","pai":""}
    ];

    // Fun√ß√µes de Utilidade (MANTIDO)
    function showNotification(message, type) { /* ... */ }
    function showSpinner() { /* ... */ }
    function hideSpinner() { /* ... */ }

    // Gerenciamento do IndexedDB (MANTIDO)
    async function initIndexedDB() { /* ... */ }
    function getLastPhotoId() { /* ... */ }

    // Salvar e Carregar Respostas (MANTIDO)
    function saveAppState() { /* ... */ }
    function loadAppState() { /* ... */ }
    function applyAnswersToForm() {
        Object.keys(APP_STATE.respostasFormulario).forEach(inputId => {
            const value = APP_STATE.respostasFormulario[inputId];
            const input = document.getElementById(inputId);
            
            if (input) {
                if (input.type === 'radio') {
                    const radio = document.querySelector(`input[name="${inputId}"][value="${value}"]`);
                    if (radio) radio.checked = true;
                } else if (input.classList.contains('camera-input')) {
                    const container = input.closest('.flex') || input.closest('.input-area');
                    if (container) {
                        const infoEl = container.querySelector('.photo-info');
                        if(infoEl) infoEl.textContent = `Foto Salva: ID ${value}`;
                    }
                } else if (input.type === 'hidden' && document.querySelector(`input[name="${inputId}"][type="checkbox"]`)) {
                    // Trata o caso de checkboxGroup
                    const existingOptions = value.split(';');
                    document.querySelectorAll(`input[name="${inputId}"][type="checkbox"]`).forEach(checkbox => {
                        checkbox.checked = existingOptions.includes(checkbox.value);
                    });
                } else {
                    input.value = value;
                }
            }
        });
        // Ap√≥s carregar os dados, re-aplica a visibilidade condicional
        document.querySelectorAll('.pergunta-card[data-pai]').forEach(card => {
            const parentId = card.dataset.pai;
            const parentInput = document.getElementById(parentId);
            if (parentInput) {
                const parentValue = APP_STATE.respostasFormulario[parentId] || (parentInput.type === 'radio' && document.querySelector(`input[name="${parentId}"]:checked`) ? document.querySelector(`input[name="${parentId}"]:checked`).value : parentInput.value);
                checkConditionalVisibility(parentId, parentValue);
            }
        });
        updateProgress();
    }

    // L√≥gica Condicional: Exibe ou oculta perguntas baseadas na resposta pai
    function checkConditionalVisibility(parentId, parentValue) {
        // Encontra todas as perguntas que dependem do pai
        document.querySelectorAll(`.pergunta-card[data-pai="${parentId}"]`).forEach(card => {
            const condicao = card.dataset.condicao;
            const inputId = card.querySelector('.input-area').dataset.inputId;
            let isVisible = false;

            // Checa se a resposta do pai (parentValue) inclui a condi√ß√£o necess√°ria
            // Isso funciona para radio (valor √∫nico) e checkboxGroup (valores separados por ;)
            if (parentValue && parentValue.includes(condicao)) {
                isVisible = true;
            }
            
            if (isVisible) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
                
                // Limpa a resposta do campo oculto
                if (APP_STATE.respostasFormulario[inputId]) {
                    delete APP_STATE.respostasFormulario[inputId];
                    
                    const inputElement = document.getElementById(inputId);
                    if (inputElement) inputElement.value = '';
                    
                    document.querySelectorAll(`input[name="${inputId}"]`).forEach(el => {
                        if(el.type === 'radio' || el.type === 'checkbox') el.checked = false;
                    });
                }
            }
            
            // Re-aplica o filtro de se√ß√£o, se estiver ativo
            const selectedSecao = document.getElementById('secao_select').value;
            if(selectedSecao !== '' && card.dataset.secao !== selectedSecao && isVisible){
                card.style.display = 'none';
            }
        });
        updateProgress();
    }


    // Gera√ß√£o do Formul√°rio e L√≥gica (ATUALIZADA PARA NOVOS TIPOS E CONDI√á√ÉO)
    function generateForm() {
      const container = document.getElementById('perguntas_container');
      container.innerHTML = '';
      
      ROTEIRO_JSON.forEach(p => {
        const inputId = `pergunta_${p.id}`;
        const card = document.createElement('div');
        card.className = 'section-card pergunta-card';
        card.dataset.secao = p.secao;
        
        // Adiciona atributos para a l√≥gica condicional
        if (p.pai) {
            card.dataset.pai = `pergunta_${p.pai}`; // ID do input pai (ex: pergunta_1)
            card.dataset.condicao = p.condicao;      // Valor que deve ser correspondido (ex: Sim)
            card.style.display = 'none'; // Esconde por padr√£o
        }
        
        const content = `
          <p class="font-bold text-gray-800 mb-2">${p.id}. ${p.pergunta}</p>
          <div class="input-area" data-input-id="${inputId}">
            ${renderInput(p, inputId)}
          </div>
        `;
        card.innerHTML = content;
        container.appendChild(card);
      });
      
      // A visibilidade √© ajustada ap√≥s o loadAppState/applyAnswersToForm
    }
    
    function renderInput(p, inputId) {
      const existingValue = APP_STATE.respostasFormulario[inputId] || '';
      const tipo = p.tipoinput;
      const opcoes = p.opcao ? p.opcao.split(';') : [];

      switch (tipo) {
        case 'radio':
          return opcoes.map(opt => `
            <div class="flex items-center">
              <input id="${inputId}_${opt}" name="${inputId}" type="radio" value="${opt}" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" ${existingValue === opt ? 'checked' : ''}>
              <label for="${inputId}_${opt}" class="ml-2 block text-sm text-gray-900">${opt}</label>
            </div>
          `).join('');
        
        case 'checkboxGroup':
            // O valor do APP_STATE √© uma string separada por ';'
            const existingOptions = existingValue.split(';'); 
            return opcoes.map(opt => `
                <div class="flex items-center">
                    <input id="${inputId}_${opt}" name="${inputId}" type="checkbox" value="${opt}" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 checkbox-group-input" ${existingOptions.includes(opt) ? 'checked' : ''}>
                    <label for="${inputId}_${opt}" class="ml-2 block text-sm text-gray-900">${opt}</label>
                </div>
            `).join('');

        case 'textarea':
          return `<textarea id="${inputId}" name="${inputId}" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md p-2">${existingValue}</textarea>`;
        case 'number':
        case 'date':
          return `<input type="${tipo}" id="${inputId}" name="${inputId}" class="mt-1 block w-full border border-gray-300 rounded-md p-2" value="${existingValue}">`;
          
        case 'file': // Tratado como C√¢mera/Photo
          const photoInfoText = existingValue ? `Foto Salva: ID ${existingValue}` : 'Nenhuma foto salva';
          return `
            <div class="flex items-center justify-between mt-2">
              <button type="button" class="bg-indigo-600 text-white btn py-2 px-4 hover:bg-indigo-700 open-camera-btn" data-input-id="${inputId}">
                Abrir C√¢mera
              </button>
              <span class="text-sm text-gray-600 photo-info">${photoInfoText}</span>
              <input type="hidden" id="${inputId}" class="camera-input" value="${existingValue}">
            </div>
          `;
        default:
          return '';
      }
    }
    
    function updateProgress() { /* ... */ }

    // L√≥gica da C√¢mera (MANTIDO)
    function openCamera(inputId) { /* ... */ }
    function capturePhoto() { /* ... */ }
    async function savePhotoAndClose() { /* ... */ }
    function closeCameraModal() { /* ... */ }
    
    // Fun√ß√µes de Download (VERS√ÉO ZIP - MANTIDO)
    function getAllPhotos() { /* ... */ }
    async function downloadReportZip() { /* ... */ }


    // Gerenciamento de Eventos e Inicializa√ß√£o (ATUALIZADA)
    function setupAppListeners() {
      // Listener para a Se√ß√£o de Abertura (MANTIDO)
      document.getElementById('iniciar_formulario').addEventListener('click', () => {
        const avaliador = document.getElementById('avaliador').value.trim();
        const local = document.getElementById('local').value.trim();
        
        if (avaliador === '' || local === '') {
          showNotification('Preencha o Avaliador e o Local da Visita para continuar.', 'error');
          return;
        }
        
        APP_STATE.avaliador = avaliador;
        APP_STATE.local = local;
        saveAppState();
        
        document.getElementById('secao_abertura').classList.add('hidden');
        document.getElementById('secao_formulario').classList.remove('hidden');
        generateForm();
      });
      
      // Listener para o Filtro de Se√ß√£o (MANTIDO)
      document.getElementById('secao_select').addEventListener('change', (e) => {
        const selectedSecao = e.target.value;
        document.querySelectorAll('.pergunta-card').forEach(card => {
            const isConditionalHidden = card.style.display === 'none' && card.dataset.pai;
            
            if (selectedSecao === '' || card.dataset.secao === selectedSecao) {
                // S√≥ exibe se n√£o estiver oculto pela l√≥gica condicional
                if(!isConditionalHidden) {
                    card.style.display = 'block';
                }
            } else {
                card.style.display = 'none';
            }
        });
      });
      
      // Listener de eventos de input no formul√°rio (Delegation)
      document.getElementById('perguntas_container').addEventListener('input', (e) => {
        const target = e.target;
        const inputId = target.name || target.id;
        
        if (inputId.startsWith('pergunta_') && target.type !== 'file' && target.type !== 'hidden') {
          let value;
          
          if (target.type === 'radio' || target.type === 'textarea' || target.type === 'number' || target.type === 'date') {
              value = target.value;
          } else if (target.type === 'checkbox') {
              // Para checkbox, o valor √© uma string de todos os checados separados por ';'
              const checkboxGroup = document.querySelectorAll(`input[name="${target.name}"]:checked`);
              value = Array.from(checkboxGroup).map(cb => cb.value).join(';');
          } else {
              return; // Ignora outros tipos
          }

          APP_STATE.respostasFormulario[inputId] = value;
          saveAppState();
          updateProgress();
          
          // **NOVO: Checagem condicional ap√≥s a mudan√ßa do input**
          checkConditionalVisibility(inputId, value);
        }
      });
      
      // Listener para abrir a c√¢mera (MANTIDO)
      document.getElementById('perguntas_container').addEventListener('click', (e) => {
        if (e.target.classList.contains('open-camera-btn')) {
          e.preventDefault();
          const inputId = e.target.dataset.inputId;
          openCamera(inputId);
        }
      });
      
      // Listeners do Modal da C√¢mera (MANTIDO)
      document.getElementById('capture_photo').addEventListener('click', capturePhoto);
      document.getElementById('retake_photo').addEventListener('click', () => openCamera(currentCameraInput));
      document.getElementById('save_photo').addEventListener('click', savePhotoAndClose);
      document.getElementById('cancel_camera').addEventListener('click', closeCameraModal);
      
      // Listener para o bot√£o de Download (ZIP) (MANTIDO)
      document.getElementById('baixar_excel').addEventListener('click', downloadReportZip);
      
      // Listener de Finalizar (MANTIDO)
      document.getElementById('finalizar_visita').addEventListener('click', () => {
        showNotification('Visita Finalizada! Baixe o relat√≥rio completo (ZIP) para enviar.','success');
      });
      
      // Listener de metadados (MANTIDO)
      document.getElementById('avaliador').addEventListener('input', (e) => {
          APP_STATE.avaliador = e.target.value.trim();
          saveAppState();
      });
      document.getElementById('local').addEventListener('input', (e) => {
          APP_STATE.local = e.target.value.trim();
          saveAppState();
      });
    }

    async function initApp(){
      await initIndexedDB();
      loadAppState();
      
      lastPhotoId = await getLastPhotoId(); 
      
      // Prepara o seletor de se√ß√£o (MANTIDO)
      const secoes = [...new Set(ROTEIRO_JSON.map(p=>p.secao))];
      const selectEl = document.getElementById('secao_select');
      selectEl.innerHTML = '<option value="">-- Todas as Se√ß√µes --</option>';
      secoes.forEach(sec=>{ 
        const opt = document.createElement('option'); 
        opt.value = sec; 
        opt.textContent = sec; 
        selectEl.appendChild(opt); 
      });

      // Inicializa o mapa (Leaflet) (MANTIDO)
      const defaultLat = -22.9035; 
      const defaultLng = -43.2096;
      const mapa = L.map('mapa_local').setView([defaultLat, defaultLng], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(mapa);
      L.marker([defaultLat, defaultLng]).addTo(mapa).bindPopup('Local da Visita (Padr√£o)').openPopup();
      
      if(navigator.geolocation){ 
        navigator.geolocation.getCurrentPosition(pos=>{ 
          const {latitude,longitude} = pos.coords; 
          mapa.setView([latitude,longitude],14); 
          L.marker([latitude,longitude]).addTo(mapa).bindPopup('Sua Posi√ß√£o Atual').openPopup(); 
        }, (err)=>{ 
          console.warn('Geolocation falhou', err.message); 
        }); 
      }

      setupAppListeners();
      
      if (APP_STATE.avaliador && APP_STATE.local) {
        document.getElementById('secao_abertura').classList.add('hidden');
        document.getElementById('secao_formulario').classList.remove('hidden');
        generateForm();
      }
    }

    window.addEventListener('load', initApp);
    
    // Servi√ßo de worker para offline (MANTIDO)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => console.log('Service Worker registrado com sucesso: ', reg.scope))
          .catch(err => console.log('Falha no registro do Service Worker: ', err));
      });
    }
    
  </script>

</body>
</html>
